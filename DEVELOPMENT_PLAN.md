# JR-100 Python移植プロジェクト 開発計画書

## 1. プロジェクト概要

- **案件名**: JR-100 Emulator v2（Java）→ Python + Pygame 移植
- **目的**: オリジナルJava版と等価のエミュレータ機能をPythonで再現し、デスクトップ環境向けに起動可能な実装・テスト基盤を整備する。
- **背景**: 現行リポジトリはJava/JInput依存かつ配布がjar中心。Python移植により依存軽減と将来の機能拡張を容易にする。

## 2. 目標

1. Python実装一式（`pyjr100/`）と起動スクリプト（`run.py`）を整備する。
2. JR-100 BASIC画面がPygame上で表示され、キーボード入力・PRGロードが機能する。
3. pytestベースの自動テストと簡易ゴールデンテストで主要ユニットを検証する。
4. エージェント運用方針（`AGENTS.md`）に沿った反復開発フローを確立する。

## 3. スコープ

- CPU/メモリ/VRAM/キーボード/サウンド/ローダなどJava版主要機能のPython移植。
- Pygameによる表示・入力・初期音声処理。
- PROG形式ローダ互換の実装およびサンプルPRG読み込み。
- MITライセンス継承、Python依存関係管理、pytestによるCI準備。

### 非スコープ

- 新規機能（拡張UI、追加フォーマット、ネットワークなど）。
- ROM/PRGなど第三者権利物の同梱。
- Web配信やPygame Web最適化。

## 4. 成果物

- Pythonコードベース（`pyjr100/`）と`run.py`。
- `AGENTS.md`（エージェント向け運用手順）と本書`DEVELOPMENT_PLAN.md`。
- pytestテストスイート（ユニット・ゴールデンテスト）。
- 依存関係定義（`requirements-dev.txt`）と実行手順を含む`README.md`更新。

## 5. 前提条件

- 対象Pythonバージョン: 3.10以上。
- 主要ライブラリ: pygame 2.5+, pytest。
- 対応OS: Windows/macOS/Linux。
- Java版リポジトリ（`src/jp/asamomiji/**`）を参照し仕様を抽出。

## 6. 体制・役割

- **Codexエージェント**: 各タスクごとに仕様確認→実装→テスト→レビューまでを担当。
- **レビュア/承認者**: ユーザー。設計判断や外部依存導入時に確認。
- **CI**: GitHub Actions等（後工程で整備）。初期段階はローカルpytest実行。

## 7. 進行方針

1. **調査フェーズ**: Java版のクラス構造・責務のマッピング（T1）。
2. **コア実装フェーズ**: CPU（T2）とメモリ/バス（T3）の移植・テスト整備。
3. **表示・入力統合フェーズ**: VRAM描画（T4）とキーボード（T5）。
4. **ローダ統合フェーズ**: PROGローダ実装（T7）とサンプルPRG検証。
5. **UI統合フェーズ**: Pygameメインループ（T8）と起動スクリプト。
6. **音声・チューニングフェーズ**: 基本ビープ（T6）とパフォーマンス調整。
7. **テスト・CIフェーズ**: pytest拡充とCI設定（T9）。

## 8. タスク構成・完了条件

| タスクID | 概要 | 完了条件 |
| --- | --- | --- |
| T1 | Java版調査・対応表作成 | `AGENTS.md`にコンポーネント対応表と調査課題が記載されていること |
| T2 | CPUコア（MB8861）移植 | 主要命令が実装され、pytest命令テストが緑になること |
| T3 | メモリ/バス層 | メモリマップ定義とI/Oディスパッチが機能し、境界テストが通過すること |
| T4 | 映像出力 | VRAMからPygame Surfaceへ描画し、BASIC初期画面が確認できること |
| T5 | キーボード入力 | Pygameイベント→JR-100マトリクス変換が動作し、BASIC入力が可能なこと |
| T6 | 音声 | 基本ビープ機能が実装され、音声処理によるクラッシュが無いこと |
| T7 | PROGローダ | サンプルPRGがロード・実行できること |
| T8 | UI統合 | `run.py`から起動し、FPS制御と終了処理が機能すること |
| T9 | テスト/CI | pytestスイート整備、必要に応じGitHub Actions導入 |

## 9. スケジュール指針（相対）

| フェーズ | 期間目安 | 主な成果 |
| --- | --- | --- |
| 調査 (T1) | 1日 | 対応表、追加調査リスト |
| コア実装 (T2-T3) | 3〜4日 | CPU/メモリ実装・テスト |
| 表示・入力 (T4-T5) | 3日 | BASIC画面・キーボード入力確認 |
| ローダ統合 (T7) | 2日 | PROGロード・サンプル動作 |
| UI統合 (T8) | 2日 | メインループ・パラメータ処理 |
| 音声 (T6) | 1日 | ビープ再現（必要なら短縮） |
| テスト/CI (T9) | 1〜2日 | pytest整備・CI設定 |

※フェーズは重なり得る。各タスクはGitブランチまたはPR単位で進行する。

## 10. 品質保証・テスト方針

- pytestでCPU命令、メモリマップ、VRAM描画、キーマトリクス、PROGローディングを検証。
- ゴールデンテスト: VRAMダンプ→PNG比較、キーボード入力シナリオのスナップショットを準備。
- `run.py`実行時の統合テストシナリオ（ROM未指定時メッセージ、PRGロード後の挙動）を手順化。
- 主要コンポーネントで型ヒントとmypy（一部）導入を検討。

## 11. リスクと軽減策

- **CPUタイミング差**: サイクル数テーブルをJavaから引用し、自動テストで差異を検出。
- **キーボード配列差**: スキャンコードマッピングを設定ファイル化し、地域差の回避策を用意。
- **PROG仕様差異**: jr100emulibとの互換比較を行い、サンプルPRGで検証。
- **パフォーマンス**: Pygameの描画更新をダーティ矩形orタイル単位に最適化。
- **ライブラリ依存**: pygameバージョン差に注意し、`requirements-dev.txt`で明記。

## 12. プロセス・レビュー

- 各タスクは`AGENTS.md`のテンプレートを利用したCodexプロンプトで実施。
- 実装後はpytest実行→差分確認→レビューノート作成の順に進める。
- レビューでは機能差・性能影響・テスト充足を優先的に確認。

## 13. 環境・ツール

- 仮想環境: `.venv` を利用し依存の隔離を徹底。
- エディタ: VS Code, PyCharm 等（任意）。
- バージョン管理: Git（ブランチ戦略はGitHub Flow想定）。
- CI/CD: GitHub Actions（pytestジョブ、将来的にlintジョブ追加）。

## 14. 文書管理

- 本計画書および`AGENTS.md`はプロジェクトルートに配置し、変更時はPull Requestでレビュー。
- 設計メモや追加仕様は`docs/`（必要に応じて作成）に集約。
- 重要な調査結果は`AGENTS.md`付録またはissueにリンク。

---

最終更新日: 2025-09-21
